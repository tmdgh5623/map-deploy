<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¹´ì¹´ì˜¤ ì§€ë„ - ê³„ì•½ì²˜ ì ê²€</title>
  <style>
    #map { width: 100%; height: 90vh; }
    #filters { padding: 10px; background: #f0f0f0; }
    label { margin-right: 10px; }
    .label-overlay {
      background: white;
      border: 1px solid #888;
      padding: 2px 6px;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0px 0px 2px rgba(0, 0, 0, 0.3);
    }
  </style>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=857fa34114fff62fa488d807a8666fcc&autoload=false&libraries=services,clusterer"></script>
<body>
<div id="filters" style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px; padding: 10px; background: #f0f0f0;">
  <!-- ì›” ì„ íƒ í•„í„° -->
  <div>
    ì›”:
    <span id="month-filter">
      <label><input type="checkbox" name="month" value="01" onchange="renderMarkers()">1ì›”</label>
      <label><input type="checkbox" name="month" value="02" onchange="renderMarkers()">2ì›”</label>
      <label><input type="checkbox" name="month" value="03" onchange="renderMarkers()">3ì›”</label>
      <label><input type="checkbox" name="month" value="04" onchange="renderMarkers()">4ì›”</label>
      <label><input type="checkbox" name="month" value="05" onchange="renderMarkers()">5ì›”</label>
      <label><input type="checkbox" name="month" value="06" onchange="renderMarkers()">6ì›”</label>
      <label><input type="checkbox" name="month" value="07" onchange="renderMarkers()">7ì›”</label>
      <label><input type="checkbox" name="month" value="08" onchange="renderMarkers()">8ì›”</label>
      <label><input type="checkbox" name="month" value="09" onchange="renderMarkers()">9ì›”</label>
      <label><input type="checkbox" name="month" value="10" onchange="renderMarkers()">10ì›”</label>
      <label><input type="checkbox" name="month" value="11" onchange="renderMarkers()">11ì›”</label>
      <label><input type="checkbox" name="month" value="12" onchange="renderMarkers()">12ì›”</label>
    </span>
  </div>
<!-- âœ… ë‚´ ìœ„ì¹˜ ë²„íŠ¼ -->
<div style="padding: 10px;">
  <button onclick="showUserLocation()" style="padding: 6px 12px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
  <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMwMDdCRkYiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==" width="16" height="16">
  ë‚´ ìœ„ì¹˜
</button>
</div>
  <!-- ê²€ìƒ‰ì°½ -->
  <div>
    ëŒ€ìƒì²˜ëª…: <input type="text" id="search" oninput="renderMarkers()" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
  </div>

  <!-- âœ… ë§ˆì»¤ ë²”ë¡€ -->
  <div style="margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 13px;">
    <b>ğŸ“Œ ë§ˆì»¤ ì„¤ëª…</b>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iNyIgZmlsbD0iI0IyMjIyMiIvPjwvc3ZnPg==" width="16" height="16"> ì¢…í•©</div>
      <div><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJub25lIi8+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIGZpbGw9IiNCMjIyMjIiLz48L3N2Zz4=" width="16" height="16"> ì‘ë™</div>
      <div><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBvbHlnb24gcG9pbnRzPSI4LDEzIDUsMyAxMSwzIiBmaWxsPSIjRkYwMDAwIi8+PC9zdmc+" width="16" height="16"> ì „ì²´</div>
    </div>
  </div>
</div>

  <div style="display: flex;">
    <div id="sidebar" style="width: 300px; max-height: 90vh; overflow-y: auto; background: #fff; border-right: 1px solid #ccc; padding: 10px;">
      <h3>ğŸ“Œ ëŒ€ìƒì²˜ ëª©ë¡</h3>
      <ul id="location-list" style="list-style: none; padding: 0;"></ul>
    </div>
    <div id="map" style="flex: 1;"></div>
  </div>

<script>
  let map, geocoder, markers = [], openInfowindow = null, hoverLabel = null;
  let geocodedData = [], rawData = {};
  let labelOverlays = [];

function showUserLocation() {
  if (!navigator.geolocation) {
    alert("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const latlng = new kakao.maps.LatLng(lat, lng);

      // âœ… íŒŒë€ ë™ê·¸ë¼ë¯¸ ë§ˆì»¤
      const userIcon = new kakao.maps.MarkerImage(
        "data:image/svg+xml;base64," + btoa(`
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">
            <circle cx="12" cy="12" r="10" fill="#007BFF" stroke="white" stroke-width="2"/>
          </svg>
        `),
        new kakao.maps.Size(24, 24)
      );

      const marker = new kakao.maps.Marker({
        position: latlng,
        map: map,
        title: "ë‚´ ìœ„ì¹˜",
        image: userIcon
      });

      map.setCenter(latlng);
      map.setLevel(4);
    },
    (error) => {
      alert("âš ï¸ ìœ„ì¹˜ ì ‘ê·¼ì„ í—ˆìš©í•´ì•¼ ë‚´ ìœ„ì¹˜ë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      console.error(error);
    }
  );
}

window.addEventListener("DOMContentLoaded", () => {
  kakao.maps.load(async () => {
    const container = document.getElementById("map");
    const options = {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 7
    };
    map = new kakao.maps.Map(container, options);

    geocoder = new kakao.maps.services.Geocoder();

kakao.maps.event.addListener(map, 'zoom_changed', updateLabelVisibility);

      const response = await fetch("https://script.google.com/macros/s/AKfycbxt2faMDlOQbDObnqqL9bKmjo1OuFsdL-xs2mdYrLLHmh7zIKAdC4hMA92MaYMdcHPx7Q/exec");
      rawData = await response.json();

      const addressSet = new Set();
      const addressQueue = [];

      for (const sheet in rawData) {
        for (const item of rawData[sheet]) {
          const roadAddr = item["ë„ë¡œëª…ì£¼ì†Œ"];
          const jibunAddr = item["ì§€ë²ˆì£¼ì†Œ"];
          const address = roadAddr || jibunAddr;
          const name = item["ì›”ê´€ë¦¬ëŒ€ìƒì²˜"] || item["ë‹¨íƒ€ëŒ€ìƒì²˜"] || item["ê±°ë˜ì²˜ëª…"] || "ì´ë¦„ì—†ìŒ";
          if (!address || name.includes("ê³„ì•½í•´ì§€")) continue;

          const addressKey = address + "_" + name;
          if (addressSet.has(addressKey)) continue;

          addressSet.add(addressKey);
          addressQueue.push({ address, roadAddr, jibunAddr, sheet, item });
        }
      }

      const maxConcurrent = 5;
      let currentIndex = 0;

      async function processNextBatch() {
        const batch = addressQueue.slice(currentIndex, currentIndex + maxConcurrent);
        const promises = batch.map(({ address, roadAddr, jibunAddr, sheet, item }) => {
          return new Promise(resolve => {
            function tryGeocode(addrList, index = 0) {
              if (index >= addrList.length) return resolve();
              geocoder.addressSearch(addrList[index], (result, status) => {
                if (status === kakao.maps.services.Status.OK) {
                  geocodedData.push({
                    lat: parseFloat(result[0].y),
                    lng: parseFloat(result[0].x),
                    sheet, item
                  });
                  resolve();
                } else {
                  tryGeocode(addrList, index + 1);
                }
              });
            }

            const addrCandidates = [];
            if (roadAddr) addrCandidates.push(roadAddr);
            if (jibunAddr) addrCandidates.push(jibunAddr);
            tryGeocode(addrCandidates);
          });
        });

        await Promise.all(promises);
        currentIndex += maxConcurrent;

        if (currentIndex < addressQueue.length) {
          await new Promise(r => setTimeout(r, 100));
          await processNextBatch();
        }
      }

await processNextBatch();
renderMarkers();
  });
}); 
</script>
    function getMarkerType(sheet, item, selectedMonths) {
  const ì¢…í•© = String(item["ì¢…í•©"] || "");
  const ì‘ë™ = String(item["ì‘ë™"] || "");

  if (selectedMonths.length === 0) return "ì „ì²´";

  for (const month of selectedMonths) {
    const regex = new RegExp(`\\b0?${month}\\b`);
    if (regex.test(ì¢…í•©)) return "ì¢…í•©";
    if (regex.test(ì‘ë™)) return "ì‘ë™";
  }

  return null;
}


function getSelectedMonths() {
  const checkboxes = document.querySelectorAll('input[name="month"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function renderMarkers() {
  labelOverlays.forEach(label => label.setMap(null));  // âœ… ì´ì „ ê¸€ì ì§€ìš°ê¸°
  labelOverlays = [];

  if (openInfowindow) {
    openInfowindow.close();
    openInfowindow = null;
  }

  markers.forEach(m => m.setMap(null));
  markers = [];

      const selectedMonths = getSelectedMonths();
      const search = document.getElementById("search").value.trim();
      const getName = (sheet, item) => item["ì›”ê´€ë¦¬ëŒ€ìƒì²˜"] || item["ë‹¨íƒ€ëŒ€ìƒì²˜"] || item["ê±°ë˜ì²˜ëª…"] || "ì´ë¦„ì—†ìŒ";

      document.getElementById("location-list").innerHTML = "";

      const filtered = geocodedData.filter(({ sheet, item }) => {
        const name = getName(sheet, item);
        if (search && !name.includes(search)) return false;
        if (name.includes("ê³„ì•½í•´ì§€")) return false;
        const markerType = getMarkerType(sheet, item, selectedMonths);
        return markerType !== null;
      });

      filtered.forEach(({ lat, lng, sheet, item }) => {
        const name = getName(sheet, item);
        const type = getMarkerType(sheet, item, selectedMonths);
        const icon = getCustomMarkerIcon(type);

const marker = new kakao.maps.Marker({
  position: new kakao.maps.LatLng(lat, lng),
  map, title: name,
  image: icon
});


const label = new kakao.maps.CustomOverlay({
  position: marker.getPosition(),
  content: `<div style="
    padding: 2px 6px;
    font-size: 13px;
    font-weight: bold;
    color: black;
    white-space: nowrap;
    border-radius: 4px;
  ">${name}</div>`,
  yAnchor: 2.0,
  zIndex: 3
});

label.setMap(null);  // ê¸°ë³¸ì€ ìˆ¨ê¹€
labelOverlays.push(label);

        const getValue = key => item[key]?.toString().split("T")[0] || "-";
        const ì¢…í•© = String(item["ì¢…í•©"] || "");
        const ì‘ë™ = String(item["ì‘ë™"] || "");
        const ì¢…í•©ì›” = (ì¢…í•©.match(/\d+/g) || []).map(m => m.padStart(2, "0"));
        const ì‘ë™ì›” = (ì‘ë™.match(/\d+/g) || []).map(m => m.padStart(2, "0"));
        const types = [];

        if (selectedMonths.length === 0) {
          if (ì¢…í•©ì›”.length > 0) types.push("ì¢…í•©");
          if (ì‘ë™ì›”.length > 0) types.push("ì‘ë™");
        } else {
          if (ì¢…í•©ì›”.includes(selectedMonths)) types.push("ì¢…í•©");
          if (ì‘ë™ì›”.includes(selectedMonths)) types.push("ì‘ë™");
        }

const content = `
  <div style="padding:10px 10px 20px; font-size:13px; line-height:1.6; max-width:320px; max-height:280px; overflow-y:auto;">
    <table style="border-spacing:0; width:100%; table-layout:fixed;">
      <colgroup>
        <col style="width:80px; text-align:right;">
        <col style="width:auto;">
      </colgroup>
      <tbody style="word-break:break-word;">
        <tr><td style="text-align:right;"><b>ëŒ€ìƒì²˜ëª…</b></td><td style="padding-left:6px;">${name}</td></tr>
        <tr><td style="text-align:right;"><b>ê³„ì•½êµ¬ë¶„</b></td><td style="padding-left:6px;">${sheet}</td></tr>
        ${types.length ? `<tr><td style="text-align:right;"><b>ì ê²€êµ¬ë¶„</b></td><td style="padding-left:6px;">${types.join(", ")}</td></tr>` : ""}
        ${item["ì£¼ìš©ë„"] ? `<tr><td style="text-align:right;"><b>ì£¼ìš©ë„</b></td><td style="padding-left:6px;">${item["ì£¼ìš©ë„"]}</td></tr>` : ""}
        ${getValue("ì‚¬ìš©ìŠ¹ì¸ì›”") ? `<tr><td style="text-align:right;"><b>ì‚¬ìš©ìŠ¹ì¸ì¼</b></td><td style="padding-left:6px;">${getValue("ì‚¬ìš©ìŠ¹ì¸ì›”")}</td></tr>` : ""}
        ${item["ë„ë¡œëª…ì£¼ì†Œ"] ? `<tr><td style="text-align:right;"><b>ì£¼ì†Œ</b></td><td style="padding-left:6px;">${item["ë„ë¡œëª…ì£¼ì†Œ"]}</td></tr>` : ""}
        ${item["ì—°ë½ì²˜"] ? `<tr><td style="text-align:right;"><b>ì—°ë½ì²˜</b></td><td style="padding-left:6px;">${item["ì—°ë½ì²˜"]}</td></tr>` : ""}
        ${item["ì—°ë©´ì ã¡"] ? `<tr><td style="text-align:right;"><b>ì—°ë©´ì </b></td><td style="padding-left:6px;">${item["ì—°ë©´ì ã¡"]}</td></tr>` : ""}
        ${item["ì„¸ëŒ€ì ê²€ëŒ€ìƒ"] ? `<tr><td style="text-align:right;"><b>ì„¸ëŒ€ì ê²€</b></td><td style="padding-left:6px;">${item["ì„¸ëŒ€ì ê²€ëŒ€ìƒ"]}</td></tr>` : ""}
        <tr><td style="text-align:right;"><b>ì„¤ë¹„</b></td>
            <td style="padding-left:6px;">ì˜¥ë‚´:${item["ì˜¥ë‚´"] || "-"}, SP:${item["S/P"] || "-"}, ê°€ìŠ¤:${item["ê°€ìŠ¤"] || "-"}</td></tr>
        ${item["ê±´ë¬¼í˜„í™©"] ? `<tr><td style="text-align:right;"><b>ê±´ë¬¼í˜„í™©</b></td><td style="padding-left:6px;">${item["ê±´ë¬¼í˜„í™©"]}</td></tr>` : ""}
        ${item["ë¹„ê³ "] ? `<tr><td style="text-align:right; vertical-align:top;"><b>ë¹„ê³ </b></td><td style="padding-left:6px; white-space:pre-wrap;">${item["ë¹„ê³ "]}</td></tr>` : ""}
      </tbody>
    </table>
  </div>`;

        const infowindow = new kakao.maps.InfoWindow({ content });

kakao.maps.event.addListener(marker, 'click', () => {
  if (openInfowindow && openInfowindow.getContent() === infowindow.getContent()) {
    openInfowindow.close();
    openInfowindow = null;
  } else {
    if (openInfowindow) openInfowindow.close();
    infowindow.open(map, marker);

    // âœ… ì§€ë„ ì¤‘ì‹¬ì„ ìœ„ë¡œ ì˜¬ë ¤ ì¸í¬ìœˆë„ìš° í•˜ë‹¨ ì˜ë¦¼ ë°©ì§€
    const latlng = marker.getPosition();
    const proj = map.getProjection();
    const point = proj.containerPointFromCoords(latlng);
    point.y -= 100;  // y ì¢Œí‘œë¥¼ ìœ„ë¡œ 100px ì´ë™
    map.setCenter(proj.coordsFromContainerPoint(point));

    openInfowindow = infowindow;
  }
});

        kakao.maps.event.addListener(marker, 'mouseover', () => {
          if (hoverLabel) hoverLabel.setMap(null);
          hoverLabel = new kakao.maps.CustomOverlay({
            position: marker.getPosition(),
            content: `<div class="label-overlay">${name}</div>`,
            yAnchor: 1.6
          });
          hoverLabel.setMap(map);
        });

        kakao.maps.event.addListener(marker, 'mouseout', () => {
          if (hoverLabel) hoverLabel.setMap(null);
        });

        const listItem = document.createElement("li");
        listItem.textContent = name;
        listItem.style.padding = "6px 0";
        listItem.style.cursor = "pointer";
        listItem.onclick = () => {
          map.setCenter(new kakao.maps.LatLng(lat, lng));
          map.setLevel(4);
          if (openInfowindow) openInfowindow.close();
          infowindow.open(map, marker);
          openInfowindow = infowindow;
        };
       document.getElementById("location-list").appendChild(listItem);

markers.push(marker);  // â† ê¸°ì¡´ ì½”ë“œ

updateLabelVisibility();  // âœ… ìš”ê¸° ì¶”ê°€

      });
    }

    function getCustomMarkerIcon(type) {
      const size = new kakao.maps.Size(32, 32);
      const redCircle = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iNyIgZmlsbD0iI0IyMjIyMiIvPjwvc3ZnPg==";
      const redSquare = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJub25lIi8+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIGZpbGw9IiNCMjIyMjIiLz48L3N2Zz4=";
      const triangle = "data:image/svg+xml;base64," + btoa('<svg width="32" height="32" xmlns="http://www.w3.org/2000/svg"><polygon points="16,24 10,10 22,10" fill="#FF0000"/></svg>');

      if (type === "ì¢…í•©") return new kakao.maps.MarkerImage(redCircle, size);
      if (type === "ì‘ë™") return new kakao.maps.MarkerImage(redSquare, size);
      if (type === "ì „ì²´") return new kakao.maps.MarkerImage(triangle, size);
      return null;
    }

function updateLabelVisibility() {
  const show = map.getLevel() <= 4;
  labelOverlays.forEach(label => {
    label.setMap(show ? map : null);
  });
}
  </script>
</body>
</html>

